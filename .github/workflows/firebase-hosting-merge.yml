# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - master

permissions:
  contents: read

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify environment variables
        run: |
          echo "Checking environment variables..."
          echo "NEXT_PUBLIC_FIREBASE_API_KEY: ${NEXT_PUBLIC_FIREBASE_API_KEY:+SET (length: ${#NEXT_PUBLIC_FIREBASE_API_KEY})}${NEXT_PUBLIC_FIREBASE_API_KEY:-NOT SET}"
          echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN:+SET}${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN:-NOT SET}"
          echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${NEXT_PUBLIC_FIREBASE_PROJECT_ID:+SET}${NEXT_PUBLIC_FIREBASE_PROJECT_ID:-NOT SET}"
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ vars.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}

      - name: Clear Next.js cache
        run: |
          rm -rf .next
          rm -rf node_modules/.cache

      - name: Install dependencies & build Next.js
        run: npm ci && npm run build
        env:
          # Client-side PUBLIC variables (from Repository Variables)
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ vars.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_APP_ID }}
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
   
          # Server-side Firebase Admin SDK secrets
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}

      - name: Setup Firebase credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_ECOMMERCE_GENERATOR_4C007 }}' > ${{ github.workspace }}/firebase-service-account.json

      - name: Verify env vars in build output
        run: |
          echo "Checking if env vars are in build output..."
          if grep -r "NEXT_PUBLIC_FIREBASE_API_KEY" .next/static/chunks/ 2>/dev/null | head -1; then
            echo "✅ Found NEXT_PUBLIC_FIREBASE_API_KEY in build output"
          else
            echo "❌ NEXT_PUBLIC_FIREBASE_API_KEY not found in build output"
          fi

      - name: Deploy to Firebase Hosting (Production)
        run: npx firebase-tools@latest deploy --only hosting --project ecommerce-generator-4c007 --force
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/firebase-service-account.json

